<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç°ä»£åŒ–è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            align-items: center;
            justify-content: center;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .score-display {
            text-align: center;
        }

        .current-score {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff88;
        }

        .high-score {
            font-size: 1em;
            color: #ffd700;
            margin-top: 5px;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .game-canvas {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.3);
        }

        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-title {
            font-size: 4em;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ffff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-align: center;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 20px #00ff88); }
            to { filter: drop-shadow(0 0 40px #00ffff); }
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #ccc;
            margin-bottom: 40px;
            text-align: center;
        }

        .speed-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .speed-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .speed-btn:hover, .speed-btn.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            transform: scale(1.05);
        }

        .start-btn {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.6);
        }

        .virtual-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            grid-template-areas: 
                ". up ."
                "left center right"
                ". down .";
            gap: 10px;
            z-index: 100;
        }

        .virtual-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            user-select: none;
        }

        .virtual-btn:active {
            transform: scale(0.9);
            background: rgba(0, 255, 136, 0.4);
        }

        .virtual-btn.up { grid-area: up; }
        .virtual-btn.down { grid-area: down; }
        .virtual-btn.left { grid-area: left; }
        .virtual-btn.right { grid-area: right; }

        .game-over-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            font-size: 2.5em;
            color: #ff6b6b;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 1.5em;
            color: #00ff88;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-size: 1.2em;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }

        .settings-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .game-canvas {
                width: 95vw;
                height: 60vh;
            }

            .virtual-controls {
                display: grid;
            }

            .game-header {
                padding: 15px;
                margin-bottom: 15px;
            }

            .current-score {
                font-size: 2em;
            }

            .game-title {
                font-size: 2.5em;
            }

            .speed-selection {
                margin-bottom: 20px;
            }

            .speed-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .game-canvas {
                width: 98vw;
                height: 55vh;
            }

            .current-score {
                font-size: 1.8em;
            }

            .game-title {
                font-size: 2em;
            }

            .virtual-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <a href="/" style="
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        text-decoration: none;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        z-index: 1000;
    " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">â† è¿”å›åšå®¢</a>
    <div class="game-container">
        <!-- å¼€å§‹ç•Œé¢ -->
        <div class="start-screen" id="startScreen">
            <h1 class="game-title">ç°ä»£è´ªåƒè›‡</h1>
            <p class="game-subtitle">Modern Snake Game</p>
            
            <div class="speed-selection">
                <button class="speed-btn" onclick="setGameSpeed('slow')">æ…¢é€Ÿ</button>
                <button class="speed-btn active" onclick="setGameSpeed('normal')">æ™®é€š</button>
                <button class="speed-btn" onclick="setGameSpeed('fast')">å¿«é€Ÿ</button>
                <button class="speed-btn" onclick="setGameSpeed('extreme')">æé€Ÿ</button>
            </div>
            
            <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆå¤´éƒ¨ -->
        <div class="game-header">
            <div class="score-display">
                <div class="current-score" id="currentScore">0</div>
                <div class="high-score" id="highScore">æœ€é«˜åˆ†: 0</div>
            </div>
            
            <div class="game-controls">
                <button class="control-btn" id="pauseBtn" onclick="togglePause()" title="æš‚åœ/ç»§ç»­">
                    <span id="pauseIcon">â¸ï¸</span>
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas class="game-canvas" id="gameCanvas"></canvas>

        <!-- è™šæ‹Ÿæ§åˆ¶å™¨ -->
        <div class="virtual-controls" id="virtualControls">
            <div class="virtual-btn up" id="upBtn">â†‘</div>
            <div class="virtual-btn left" id="leftBtn">â†</div>
            <div class="virtual-btn right" id="rightBtn">â†’</div>
            <div class="virtual-btn down" id="downBtn">â†“</div>
        </div>

        <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
        <div class="game-over-modal" id="gameOverModal">
            <div class="modal-content">
                <h2 class="modal-title">æ¸¸æˆç»“æŸ</h2>
                <p class="final-score" id="finalScore">å¾—åˆ†: 0</p>
                <button class="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <button class="settings-btn" onclick="toggleVirtualControls()">è™šæ‹ŸæŒ‰é”®: å¼€å¯</button>
        </div>
    </div>

    <script>
        class SnakeGame {
            constructor() {
                // æ¸¸æˆçŠ¶æ€ç®¡ç†
                this.gameState = 'start'; // 'start', 'playing', 'paused', 'gameOver'
                this.loopRunning = false;
                
                // åˆ†æ•°ç³»ç»Ÿ
                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('snakeHighScore')) || 0;
                
                // é€Ÿåº¦æ§åˆ¶
                this.baseSpeed = 150; // åŸºç¡€é€Ÿåº¦(æ¯«ç§’)
                this.speed = this.baseSpeed; // å½“å‰é€Ÿåº¦
                this.speedLevel = 'normal'; // é€Ÿåº¦ç­‰çº§
                this.lastMoveTime = 0;
                
                // æ¸¸æˆç½‘æ ¼
                this.gridSize = 20; // ç½‘æ ¼å¤§å°
                this.gridWidth = 0; // ç½‘æ ¼å®½åº¦
                this.gridHeight = 0; // ç½‘æ ¼é«˜åº¦
                
                // æ¸¸æˆå¯¹è±¡
                this.snake = []; // è›‡èº«æ•°ç»„
                this.direction = { x: 1, y: 0 }; // å½“å‰æ–¹å‘
                this.nextDirection = { x: 1, y: 0 }; // ä¸‹ä¸€ä¸ªæ–¹å‘
                this.food = null; // é£Ÿç‰©å¯¹è±¡
                this.foodType = 'normal'; // é£Ÿç‰©ç±»å‹
                
                // ç‰¹æ•ˆç³»ç»Ÿ
                this.particles = []; // ç²’å­æ•°ç»„
                this.scorePopups = []; // åˆ†æ•°å¼¹å‡ºåŠ¨ç”»
                this.speedBoost = 0; // åŠ é€Ÿæ•ˆæœè®¡æ—¶
                this.slowEffect = 0; // å‡é€Ÿæ•ˆæœè®¡æ—¶
                this.foodEatAnimation = null; // é£Ÿç‰©æ¶ˆå¤±åŠ¨ç”»
                
                // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // åˆå§‹åŒ–
                this.setupCanvas();
                this.initializeGameObjects();
                this.setupEventListeners();
                this.updateHighScoreDisplay();
            }
            
            setupCanvas() {
                // è®¡ç®—æœ€ä½³ç”»å¸ƒå°ºå¯¸
                const container = document.querySelector('.game-container');
                const maxWidth = Math.min(800, window.innerWidth * 0.9);
                const maxHeight = Math.min(600, window.innerHeight * 0.6);
                
                // ç¡®ä¿ç½‘æ ¼å®Œæ•´æ˜¾ç¤º
                this.gridWidth = Math.floor(maxWidth / this.gridSize);
                this.gridHeight = Math.floor(maxHeight / this.gridSize);
                
                this.canvas.width = this.gridWidth * this.gridSize;
                this.canvas.height = this.gridHeight * this.gridSize;
                
                // ç§»åŠ¨ç«¯ä¼˜åŒ–
                if (window.innerWidth <= 768) {
                    this.gridSize = 18;
                    this.gridWidth = Math.floor((window.innerWidth * 0.95) / this.gridSize);
                    this.gridHeight = Math.floor((window.innerHeight * 0.6) / this.gridSize);
                    this.canvas.width = this.gridWidth * this.gridSize;
                    this.canvas.height = this.gridHeight * this.gridSize;
                }
                
                // é«˜DPIå±å¹•ä¼˜åŒ–
                const dpr = window.devicePixelRatio || 1;
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
                
                // é‡æ–°è®¡ç®—ç½‘æ ¼
                this.gridWidth = Math.floor(rect.width / this.gridSize);
                this.gridHeight = Math.floor(rect.height / this.gridSize);
            }
            
            initializeGameObjects() {
                // åˆå§‹åŒ–è›‡çš„ä½ç½®
                const centerX = Math.floor(this.gridWidth / 2);
                const centerY = Math.floor(this.gridHeight / 2);
                
                this.snake = [
                    { x: centerX, y: centerY },
                    { x: centerX - 1, y: centerY },
                    { x: centerX - 2, y: centerY }
                ];
                
                // ç”Ÿæˆåˆå§‹é£Ÿç‰©
                this.food = this.generateFood();
            }
            
            setupEventListeners() {
                // é”®ç›˜æ§åˆ¶
                document.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'playing') return;
                    
                    switch(e.key) {
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            if (this.direction.y !== 1) this.nextDirection = { x: 0, y: -1 };
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            if (this.direction.y !== -1) this.nextDirection = { x: 0, y: 1 };
                            break;
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            if (this.direction.x !== 1) this.nextDirection = { x: -1, y: 0 };
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            if (this.direction.x !== -1) this.nextDirection = { x: 1, y: 0 };
                            break;
                    }
                    e.preventDefault();
                });
                
                // è§¦æ‘¸æ§åˆ¶
                let touchStartX = 0;
                let touchStartY = 0;
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (this.gameState !== 'playing') return;
                    
                    const touch = e.changedTouches[0];
                    const deltaX = touch.clientX - touchStartX;
                    const deltaY = touch.clientY - touchStartY;
                    const minSwipeDistance = 30;
                    
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        // æ°´å¹³æ»‘åŠ¨
                        if (Math.abs(deltaX) > minSwipeDistance) {
                            if (deltaX > 0 && this.direction.x !== -1) {
                                this.nextDirection = { x: 1, y: 0 }; // å³
                            } else if (deltaX < 0 && this.direction.x !== 1) {
                                this.nextDirection = { x: -1, y: 0 }; // å·¦
                            }
                        }
                    } else {
                        // å‚ç›´æ»‘åŠ¨
                        if (Math.abs(deltaY) > minSwipeDistance) {
                            if (deltaY > 0 && this.direction.y !== -1) {
                                this.nextDirection = { x: 0, y: 1 }; // ä¸‹
                            } else if (deltaY < 0 && this.direction.y !== 1) {
                                this.nextDirection = { x: 0, y: -1 }; // ä¸Š
                            }
                        }
                    }
                }, { passive: false });
                
                // è™šæ‹Ÿæ§åˆ¶å™¨
                this.setupVirtualControls();
            }
            
            setupVirtualControls() {
                const setupVirtualControl = (id, direction) => {
                    const button = document.getElementById(id);
                    if (button) {
                        // è§¦æ‘¸å¼€å§‹
                        button.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (this.gameState === 'playing') {
                                this.changeDirection(direction.x, direction.y);
                                button.style.transform = 'scale(0.9)';
                                button.style.background = 'rgba(0, 255, 136, 0.4)';
                            }
                        }, { passive: false });
                        
                        // è§¦æ‘¸ç»“æŸ
                        button.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            button.style.transform = 'scale(1)';
                            button.style.background = 'rgba(255, 255, 255, 0.2)';
                        }, { passive: false });
                        
                        // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢æµ‹è¯•ï¼‰
                        button.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (this.gameState === 'playing') {
                                this.changeDirection(direction.x, direction.y);
                                button.style.transform = 'scale(0.9)';
                                button.style.background = 'rgba(0, 255, 136, 0.4)';
                            }
                        });
                        
                        button.addEventListener('mouseup', (e) => {
                            e.preventDefault();
                            button.style.transform = 'scale(1)';
                            button.style.background = 'rgba(255, 255, 255, 0.2)';
                        });
                    }
                };
                
                // è®¾ç½®è™šæ‹Ÿæ§åˆ¶å™¨
                setupVirtualControl('upBtn', {x: 0, y: -1});
                setupVirtualControl('downBtn', {x: 0, y: 1});
                setupVirtualControl('leftBtn', {x: -1, y: 0});
                setupVirtualControl('rightBtn', {x: 1, y: 0});
            }
            
            changeDirection(x, y) {
                if (this.gameState !== 'playing') return;
                
                // é˜²æ­¢åå‘ç§»åŠ¨
                if ((x === 1 && this.direction.x === -1) || 
                    (x === -1 && this.direction.x === 1) ||
                    (y === 1 && this.direction.y === -1) || 
                    (y === -1 && this.direction.y === 1)) {
                    return;
                }
                
                // å…è®¸å¿«é€Ÿæ–¹å‘æ”¹å˜
                if (this.nextDirection.x !== x || this.nextDirection.y !== y) {
                    this.nextDirection = { x, y };
                }
            }
            
            generateFood() {
                let newFood;
                do {
                    newFood = {
                        x: Math.floor(Math.random() * this.gridWidth),
                        y: Math.floor(Math.random() * this.gridHeight)
                    };
                } while (this.snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
                
                // éšæœºç”Ÿæˆç‰¹æ®Šé£Ÿç‰©
                const rand = Math.random();
                if (rand < 0.05) {
                    this.foodType = 'golden';
                } else if (rand < 0.15) {
                    this.foodType = 'speed';
                } else if (rand < 0.25) {
                    this.foodType = 'slow';
                } else {
                    this.foodType = 'normal';
                }
                
                return newFood;
            }
            
            update(currentTime) {
                if (this.gameState !== 'playing') return;
                
                // æ›´æ–°ç‰¹æ•ˆæ—¶é—´
                if (this.speedBoost > 0) this.speedBoost--;
                if (this.slowEffect > 0) this.slowEffect--;
                
                // è®¡ç®—å½“å‰é€Ÿåº¦
                let currentSpeed = this.speed;
                if (this.speedBoost > 0) currentSpeed *= 0.7;
                if (this.slowEffect > 0) currentSpeed *= 1.5;
                
                if (currentTime - this.lastMoveTime < currentSpeed) {
                    return;
                }
                
                this.lastMoveTime = currentTime;
                
                // æ›´æ–°æ–¹å‘
                this.direction = { ...this.nextDirection };
                
                // ç§»åŠ¨è›‡å¤´
                const head = { ...this.snake[0] };
                head.x += this.direction.x;
                head.y += this.direction.y;
                
                // æ£€æŸ¥è¾¹ç•Œç¢°æ’
                if (head.x < 0 || head.x >= this.gridWidth || head.y < 0 || head.y >= this.gridHeight) {
                    this.gameOver();
                    return;
                }
                
                // æ£€æŸ¥è‡ªèº«ç¢°æ’
                if (this.snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                    this.gameOver();
                    return;
                }
                
                this.snake.unshift(head);
                
                // æ£€æŸ¥é£Ÿç‰©ç¢°æ’
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.eatFood();
                } else {
                    this.snake.pop();
                }
                
                // æ›´æ–°ç²’å­
                this.updateParticles();
            }
            
            eatFood() {
                // é£Ÿç‰©æ¶ˆå¤±åŠ¨ç”»
                this.foodEatAnimation = {
                    active: true,
                    scale: 1,
                    alpha: 1,
                    x: this.food.x * this.gridSize + this.gridSize/2,
                    y: this.food.y * this.gridSize + this.gridSize/2,
                    duration: 15,
                    timer: 0
                };
                
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                
                // æ ¹æ®é£Ÿç‰©ç±»å‹ç»™åˆ†å’Œæ•ˆæœ
                let points = 10;
                let particleColor = '#ff6b6b';
                let particleCount = 15;
                
                switch(this.foodType) {
                    case 'golden':
                        points = 50;
                        particleColor = '#ffd700';
                        particleCount = 25;
                        this.createExplosion(this.food.x * this.gridSize + this.gridSize/2, 
                                           this.food.y * this.gridSize + this.gridSize/2, '#ffd700');
                        break;
                    case 'speed':
                        points = 15;
                        particleColor = '#00ffff';
                        particleCount = 20;
                        this.speedBoost = 300; // 5ç§’åŠ é€Ÿ
                        this.createSpeedEffect();
                        break;
                    case 'slow':
                        points = 15;
                        particleColor = '#ff69b4';
                        particleCount = 20;
                        this.slowEffect = 300; // 5ç§’å‡é€Ÿ
                        this.createSlowEffect();
                        break;
                    default:
                        particleCount = 15;
                }
                
                // åˆ›å»ºåä¸½çš„ç²’å­æ•ˆæœ
                this.createAdvancedParticles(this.food.x * this.gridSize + this.gridSize/2, 
                                            this.food.y * this.gridSize + this.gridSize/2, 
                                            particleColor, particleCount);
                
                // åˆ›å»ºåˆ†æ•°é£å‡ºåŠ¨ç”»
                this.createScorePopup(points, this.food.x * this.gridSize + this.gridSize/2, 
                                     this.food.y * this.gridSize + this.gridSize/2);
                
                this.score += points;
                this.updateScore();
                
                // æ ¹æ®åˆ†æ•°å¢åŠ é€Ÿåº¦
                if (this.score % 100 === 0 && this.speed > 50) {
                    this.speed = Math.max(50, this.speed - 8);
                }
                
                this.food = this.generateFood();
            }
            
            createAdvancedParticles(x, y, color, count = 15) {
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
                    const speed = 3 + Math.random() * 6;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 30,
                        maxLife: 30,
                        color: color,
                        size: 2 + Math.random() * 4,
                        gravity: 0.15,
                        bounce: 0.7,
                        trail: []
                    });
                }
            }
            
            createExplosion(x, y, color) {
                // ä¸»çˆ†ç‚¸ç²’å­
                for (let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 4 + Math.random() * 8;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 40,
                        maxLife: 40,
                        color: color,
                        size: 3 + Math.random() * 5,
                        gravity: 0.2,
                        bounce: 0.6,
                        trail: [],
                        sparkle: true
                    });
                }
                
                // ç«èŠ±æ•ˆæœ
                for (let i = 0; i < 20; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 5;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 25,
                        maxLife: 25,
                        color: '#ffffff',
                        size: 1 + Math.random() * 3,
                        gravity: 0.1,
                        bounce: 0.8,
                        trail: []
                    });
                }
            }
            
            createSpeedEffect() {
                // è“è‰²èƒ½é‡æ³¢
                for (let i = 0; i < 25; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 3 + Math.random() * 5;
                    this.particles.push({
                        x: this.snake[0].x * this.gridSize + this.gridSize/2,
                        y: this.snake[0].y * this.gridSize + this.gridSize/2,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 50,
                        maxLife: 50,
                        color: '#00ffff',
                        size: 2,
                        gravity: 0,
                        bounce: 0,
                        trail: [],
                        glow: true
                    });
                }
            }
            
            createSlowEffect() {
                // ç²‰è‰²å‡é€Ÿæ³¢
                for (let i = 0; i < 25; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 1.5 + Math.random() * 3;
                    this.particles.push({
                        x: this.snake[0].x * this.gridSize + this.gridSize/2,
                        y: this.snake[0].y * this.gridSize + this.gridSize/2,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 55,
                        maxLife: 55,
                        color: '#ff69b4',
                        size: 3,
                        gravity: 0,
                        bounce: 0,
                        trail: [],
                        pulse: true
                    });
                }
            }
            
            createScorePopup(points, x, y) {
                this.scorePopups.push({
                    text: '+' + points,
                    x: x,
                    y: y,
                    vy: -3,
                    life: 40,
                    maxLife: 40,
                    color: points >= 50 ? '#ffd700' : '#00ff88'
                });
            }
            
            updateParticles() {
                // æ›´æ–°ç²’å­
                this.particles = this.particles.filter(particle => {
                    // ä¿å­˜è½¨è¿¹
                    if (particle.trail.length > 6) {
                        particle.trail.shift();
                    }
                    particle.trail.push({ x: particle.x, y: particle.y });
                    
                    // åº”ç”¨é‡åŠ›
                    if (particle.gravity) {
                        particle.vy += particle.gravity;
                    }
                    
                    // æ›´æ–°ä½ç½®
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // è¾¹ç•Œå¼¹è·³
                    if (particle.bounce && particle.bounce > 0) {
                        if (particle.x <= 0 || particle.x >= this.canvas.width) {
                            particle.vx *= -particle.bounce;
                            particle.x = Math.max(0, Math.min(this.canvas.width, particle.x));
                        }
                        if (particle.y <= 0 || particle.y >= this.canvas.height) {
                            particle.vy *= -particle.bounce;
                            particle.y = Math.max(0, Math.min(this.canvas.height, particle.y));
                        }
                    }
                    
                    particle.life--;
                    return particle.life > 0;
                });
                
                // æ›´æ–°åˆ†æ•°å¼¹å‡ºåŠ¨ç”»
                this.scorePopups = this.scorePopups.filter(popup => {
                    popup.y += popup.vy;
                    popup.vy *= 0.98; // å‡é€Ÿ
                    popup.life--;
                    return popup.life > 0;
                });
                
                // æ›´æ–°é£Ÿç‰©æ¶ˆå¤±åŠ¨ç”»
                if (this.foodEatAnimation && this.foodEatAnimation.active) {
                    this.foodEatAnimation.timer++;
                    const progress = this.foodEatAnimation.timer / this.foodEatAnimation.duration;
                    this.foodEatAnimation.scale = 1 + progress * 0.8; // æ”¾å¤§æ•ˆæœ
                    this.foodEatAnimation.alpha = 1 - progress;
                    
                    if (this.foodEatAnimation.timer >= this.foodEatAnimation.duration) {
                        this.foodEatAnimation.active = false;
                    }
                }
            }
            
            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#1a1a2e');
                gradient.addColorStop(1, '#16213e');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                this.ctx.lineWidth = 1;
                for (let x = 0; x <= this.gridWidth; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.gridSize, 0);
                    this.ctx.lineTo(x * this.gridSize, this.gridHeight * this.gridSize);
                    this.ctx.stroke();
                }
                for (let y = 0; y <= this.gridHeight; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.gridSize);
                    this.ctx.lineTo(this.gridWidth * this.gridSize, y * this.gridSize);
                    this.ctx.stroke();
                }
                
                // ç»˜åˆ¶é£Ÿç‰©
                this.drawFood();
                
                // ç»˜åˆ¶è›‡
                this.drawSnake();
                
                // ç»˜åˆ¶ç²’å­
                this.drawParticles();
                
                // ç»˜åˆ¶ç‰¹æ•ˆçŠ¶æ€
                this.drawEffects();
            }
            
            drawFood() {
                const x = this.food.x * this.gridSize;
                const y = this.food.y * this.gridSize;
                const centerX = x + this.gridSize / 2;
                const centerY = y + this.gridSize / 2;
                const baseRadius = this.gridSize / 3;
                
                // åŠ¨æ€è„‰å†²æ•ˆæœ
                const time = Date.now() * 0.005;
                const pulseScale = 1 + Math.sin(time) * 0.2;
                const radius = baseRadius * pulseScale;
                
                // æ ¹æ®é£Ÿç‰©ç±»å‹è®¾ç½®é¢œè‰²å’Œæ•ˆæœ
                let colors, glowColor, symbol;
                switch (this.foodType) {
                    case 'golden':
                        colors = ['#ffd700', '#ffcc00', '#e6b800'];
                        glowColor = '#ffd700';
                        symbol = 'ğŸ’';
                        break;
                    case 'speed':
                        colors = ['#00ffff', '#00cccc', '#009999'];
                        glowColor = '#00ffff';
                        symbol = 'âš¡';
                        break;
                    case 'slow':
                        colors = ['#ff69b4', '#ff1493', '#dc143c'];
                        glowColor = '#ff69b4';
                        symbol = 'â„';
                        break;
                    default:
                        colors = ['#ff6b6b', '#ff4757', '#ff3742'];
                        glowColor = '#ff6b6b';
                        symbol = 'â—';
                }
                
                // å¤šå±‚å…‰æ™•æ•ˆæœ
                for (let i = 3; i >= 1; i--) {
                    this.ctx.shadowColor = glowColor;
                    this.ctx.shadowBlur = 25 * i;
                    this.ctx.globalAlpha = 0.4 / i;
                    
                    const glowGradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius * (1 + i * 0.3));
                    glowGradient.addColorStop(0, colors[0]);
                    glowGradient.addColorStop(1, 'transparent');
                    this.ctx.fillStyle = glowGradient;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, radius * (1 + i * 0.15), 0, Math.PI * 2);
                    this.ctx.fill();
                }
                
                this.ctx.globalAlpha = 1;
                this.ctx.shadowBlur = 0;
                
                // ä¸»ä½“æ¸å˜
                const mainGradient = this.ctx.createRadialGradient(centerX - radius * 0.3, centerY - radius * 0.3, 0, centerX, centerY, radius);
                mainGradient.addColorStop(0, colors[0]);
                mainGradient.addColorStop(0.6, colors[1]);
                mainGradient.addColorStop(1, colors[2]);
                this.ctx.fillStyle = mainGradient;
                
                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                this.ctx.fill();
                
                // é«˜å…‰æ•ˆæœ
                const highlightGradient = this.ctx.createRadialGradient(centerX - radius * 0.4, centerY - radius * 0.4, 0, centerX - radius * 0.4, centerY - radius * 0.4, radius * 0.6);
                highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                highlightGradient.addColorStop(1, 'transparent');
                this.ctx.fillStyle = highlightGradient;
                
                this.ctx.beginPath();
                this.ctx.arc(centerX - radius * 0.3, centerY - radius * 0.3, radius * 0.4, 0, Math.PI * 2);
                this.ctx.fill();
                
                // æ—‹è½¬çš„è£…é¥°ç¯
                if (this.foodType !== 'normal') {
                    const rotationTime = Date.now() * 0.003;
                    this.ctx.save();
                    this.ctx.translate(centerX, centerY);
                    this.ctx.rotate(rotationTime);
                    
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([6, 6]);
                    
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, radius * 1.4, 0, Math.PI * 2);
                    this.ctx.stroke();
                    
                    this.ctx.restore();
                    this.ctx.setLineDash([]);
                }
                
                // ç¬¦å·å’Œæ–‡å­—
                this.ctx.fillStyle = 'white';
                this.ctx.shadowColor = 'black';
                this.ctx.shadowBlur = 4;
                this.ctx.font = `bold ${this.gridSize / 2.2}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // ç¬¦å·åŠ¨ç”»
                const symbolScale = 1 + Math.sin(time * 2) * 0.15;
                this.ctx.save();
                this.ctx.translate(centerX, centerY);
                this.ctx.scale(symbolScale, symbolScale);
                this.ctx.fillText(symbol, 0, 0);
                this.ctx.restore();
                
                this.ctx.shadowBlur = 0;
                
                // ç²’å­æ•ˆæœ
                if (Math.random() < 0.4) {
                    const particleX = centerX + (Math.random() - 0.5) * radius * 2.5;
                    const particleY = centerY + (Math.random() - 0.5) * radius * 2.5;
                    
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.9})`;
                    this.ctx.beginPath();
                    this.ctx.arc(particleX, particleY, Math.random() * 2.5, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawSnake() {
                // ç»˜åˆ¶è›‡èº«è¿æ¥çº¿
                if (this.snake.length > 1) {
                    this.ctx.strokeStyle = '#00cc6a';
                    this.ctx.lineWidth = this.gridSize * 0.65;
                    this.ctx.lineCap = 'round';
                    this.ctx.lineJoin = 'round';
                    
                    this.ctx.beginPath();
                    for (let i = 0; i < this.snake.length; i++) {
                        const segment = this.snake[i];
                        const centerX = segment.x * this.gridSize + this.gridSize / 2;
                        const centerY = segment.y * this.gridSize + this.gridSize / 2;
                        
                        if (i === 0) {
                            this.ctx.moveTo(centerX, centerY);
                        } else {
                            this.ctx.lineTo(centerX, centerY);
                        }
                    }
                    this.ctx.stroke();
                }
                
                // ç»˜åˆ¶è›‡èº«èŠ‚ç‚¹
                this.snake.forEach((segment, index) => {
                    const x = segment.x * this.gridSize;
                    const y = segment.y * this.gridSize;
                    const centerX = x + this.gridSize / 2;
                    const centerY = y + this.gridSize / 2;
                    const radius = this.gridSize / 2 - 2;
                    
                    if (index === 0) {
                        // è›‡å¤´ - å¢å¼ºæ•ˆæœ
                        const gradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                        gradient.addColorStop(0, '#00ff88');
                        gradient.addColorStop(0.7, '#00cc6a');
                        gradient.addColorStop(1, '#008844');
                        this.ctx.fillStyle = gradient;
                        
                        // åŠ¨æ€å…‰æ™•æ•ˆæœ
                        const glowIntensity = 18 + Math.sin(Date.now() * 0.01) * 6;
                        this.ctx.shadowColor = '#00ff88';
                        this.ctx.shadowBlur = glowIntensity;
                        
                        this.ctx.beginPath();
                        this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.shadowBlur = 0;
                        
                        // æ–¹å‘æŒ‡ç¤ºå™¨
                        this.ctx.fillStyle = '#ffffff';
                        const dirX = this.direction.x * 4;
                        const dirY = this.direction.y * 4;
                        this.ctx.beginPath();
                        this.ctx.arc(centerX + dirX, centerY + dirY, 2, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // çœ¼ç› - æ ¹æ®æ–¹å‘è°ƒæ•´
                        this.ctx.fillStyle = 'white';
                        const eyeOffsetX = this.direction.x === 0 ? 5 : this.direction.x * 3;
                        const eyeOffsetY = this.direction.y === 0 ? -5 : this.direction.y * 3;
                        
                        this.ctx.beginPath();
                        this.ctx.arc(centerX - eyeOffsetX, centerY + eyeOffsetY, 2.5, 0, Math.PI * 2);
                        this.ctx.arc(centerX + eyeOffsetX, centerY + eyeOffsetY, 2.5, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // ç³å­”
                        this.ctx.fillStyle = 'black';
                        this.ctx.beginPath();
                        this.ctx.arc(centerX - eyeOffsetX + dirX * 0.6, centerY + eyeOffsetY + dirY * 0.6, 1.2, 0, Math.PI * 2);
                        this.ctx.arc(centerX + eyeOffsetX + dirX * 0.6, centerY + eyeOffsetY + dirY * 0.6, 1.2, 0, Math.PI * 2);
                        this.ctx.fill();
                    } else {
                        // è›‡èº« - æ¸å˜æ•ˆæœ
                        const alpha = 1 - (index / this.snake.length) * 0.5;
                        const segmentRadius = radius * (1 - index * 0.015);
                        
                        const gradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, segmentRadius);
                        gradient.addColorStop(0, `rgba(0, 255, 136, ${alpha})`);
                        gradient.addColorStop(0.7, `rgba(0, 204, 106, ${alpha})`);
                        gradient.addColorStop(1, `rgba(0, 136, 68, ${alpha * 0.8})`);
                        this.ctx.fillStyle = gradient;
                        
                        // è½»å¾®çš„å…‰æ™•
                        if (index < 4) {
                            this.ctx.shadowColor = '#00ff88';
                            this.ctx.shadowBlur = 4;
                        }
                        
                        this.ctx.beginPath();
                        this.ctx.arc(centerX, centerY, segmentRadius, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.shadowBlur = 0;
                        
                        // èº«ä½“çº¹ç†
                        if (index % 2 === 0) {
                            this.ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.15})`;
                            this.ctx.beginPath();
                            this.ctx.arc(centerX, centerY, segmentRadius * 0.6, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                    }
                });
            }
            
            drawParticles() {
                this.particles.forEach(particle => {
                    const alpha = particle.life / particle.maxLife;
                    const size = (particle.size || 3) * alpha;
                    
                    // ç»˜åˆ¶è½¨è¿¹
                    if (particle.trail && particle.trail.length > 1) {
                        this.ctx.strokeStyle = particle.color + '40';
                        this.ctx.lineWidth = size * 0.6;
                        this.ctx.beginPath();
                        this.ctx.moveTo(particle.trail[0].x, particle.trail[0].y);
                        for (let i = 1; i < particle.trail.length; i++) {
                            this.ctx.lineTo(particle.trail[i].x, particle.trail[i].y);
                        }
                        this.ctx.stroke();
                    }
                    
                    // å‘å…‰æ•ˆæœ
                    if (particle.glow) {
                        this.ctx.shadowColor = particle.color;
                        this.ctx.shadowBlur = size * 2.5;
                    }
                    
                    // é—ªçƒæ•ˆæœ
                    if (particle.sparkle && Math.random() > 0.6) {
                        this.ctx.fillStyle = '#ffffff';
                    } else {
                        this.ctx.fillStyle = particle.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                    }
                    
                    // è„‰å†²æ•ˆæœ
                    let finalSize = size;
                    if (particle.pulse) {
                        finalSize *= 1 + Math.sin(Date.now() * 0.01) * 0.4;
                    }
                    
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, finalSize, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // é‡ç½®é˜´å½±
                    this.ctx.shadowBlur = 0;
                });
                
                // ç»˜åˆ¶åˆ†æ•°å¼¹å‡º
                this.scorePopups.forEach(popup => {
                    const alpha = popup.life / popup.maxLife;
                    this.ctx.fillStyle = popup.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                    this.ctx.font = 'bold 22px -apple-system';
                    this.ctx.textAlign = 'center';
                    this.ctx.shadowColor = 'black';
                    this.ctx.shadowBlur = 3;
                    this.ctx.fillText(popup.text, popup.x, popup.y);
                    this.ctx.shadowBlur = 0;
                });
                
                // ç»˜åˆ¶é£Ÿç‰©æ¶ˆå¤±åŠ¨ç”»
                if (this.foodEatAnimation && this.foodEatAnimation.active) {
                    const anim = this.foodEatAnimation;
                    this.ctx.save();
                    this.ctx.globalAlpha = anim.alpha;
                    this.ctx.translate(anim.x, anim.y);
                    this.ctx.scale(anim.scale, anim.scale);
                    
                    // ç»˜åˆ¶æ”¾å¤§çš„é£Ÿç‰©
                    this.ctx.fillStyle = this.foodType === 'golden' ? '#ffd700' : 
                                        this.foodType === 'speed' ? '#00ffff' :
                                        this.foodType === 'slow' ? '#ff69b4' : '#ff6b6b';
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, this.gridSize / 3, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    this.ctx.restore();
                }
            }
            
            drawEffects() {
                if (this.speedBoost > 0) {
                    this.ctx.fillStyle = 'rgba(0, 255, 255, 0.12)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
                if (this.slowEffect > 0) {
                    this.ctx.fillStyle = 'rgba(255, 105, 180, 0.12)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }
            
            updateScore() {
                document.getElementById('currentScore').textContent = this.score;
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('snakeHighScore', this.highScore);
                    this.updateHighScoreDisplay();
                }
            }
            
            updateHighScoreDisplay() {
                document.getElementById('highScore').textContent = `æœ€é«˜åˆ†: ${this.highScore}`;
            }
            
            gameOver() {
                this.gameState = 'gameOver';
                document.getElementById('finalScore').textContent = `å¾—åˆ†: ${this.score}`;
                document.getElementById('gameOverModal').style.display = 'flex';
            }
            
            start() {
                this.gameState = 'playing';
                document.getElementById('startScreen').style.display = 'none';
                
                // ç¡®ä¿æœ‰é£Ÿç‰©
                if (!this.food) {
                    this.food = this.generateFood();
                }
                
                // é‡ç½®ç§»åŠ¨è®¡æ—¶å™¨
                this.lastMoveTime = 0;
                
                // ç¡®ä¿è›‡çš„åˆå§‹æ–¹å‘æ­£ç¡®
                this.direction = { x: 1, y: 0 };
                this.nextDirection = { x: 1, y: 0 };
                
                // å¦‚æœæ¸¸æˆå¾ªç¯å°šæœªå¯åŠ¨ï¼Œåˆ™å¯åŠ¨å®ƒ
                if (!this.loopRunning) {
                    this.loopRunning = true;
                    this.gameLoop();
                }
            }
            
            pause() {
                this.gameState = 'paused';
                document.getElementById('pauseIcon').textContent = 'â–¶ï¸';
            }
            
            resume() {
                this.gameState = 'playing';
                document.getElementById('pauseIcon').textContent = 'â¸ï¸';
            }
            
            setSpeed(level) {
                this.speedLevel = level;
                switch(level) {
                    case 'slow':
                        this.baseSpeed = 250;
                        break;
                    case 'normal':
                        this.baseSpeed = 150;
                        break;
                    case 'fast':
                        this.baseSpeed = 100;
                        break;
                    case 'extreme':
                        this.baseSpeed = 60;
                        break;
                }
                this.speed = this.baseSpeed;
            }
            
            restart() {
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameState = 'playing';
                this.score = 0;
                this.speed = this.baseSpeed;
                
                // é‡æ–°åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡
                this.initializeGameObjects();
                
                // é‡ç½®æ–¹å‘
                this.direction = { x: 1, y: 0 };
                this.nextDirection = { x: 1, y: 0 };
                
                // æ¸…ç©ºç²’å­å’Œç‰¹æ•ˆ
                this.particles = [];
                this.scorePopups = [];
                this.speedBoost = 0;
                this.slowEffect = 0;
                this.foodEatAnimation = null;
                
                // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
                this.updateScore();
                
                // éšè—æ¸¸æˆç»“æŸæ¨¡æ€æ¡†
                document.getElementById('gameOverModal').style.display = 'none';
                
                // é‡ç½®æš‚åœå›¾æ ‡
                document.getElementById('pauseIcon').textContent = 'â¸ï¸';
                
                // é‡ç½®ç§»åŠ¨è®¡æ—¶å™¨
                this.lastMoveTime = 0;
            }
            
            gameLoop() {
                if (!this.loopRunning) return;
                
                const currentTime = performance.now();
                this.update(currentTime);
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // å…¨å±€æ¸¸æˆå®ä¾‹
        let game = null;
        
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        function startGame() {
            if (!game) {
                game = new SnakeGame();
            }
            game.start();
        }
        
        function togglePause() {
            if (!game || game.gameState === 'start' || game.gameState === 'gameOver') return;
            
            if (game.gameState === 'playing') {
                game.pause();
            } else if (game.gameState === 'paused') {
                game.resume();
            }
        }
        
        function restartGame() {
            if (game) {
                game.restart();
            }
        }
        
        function changeDirection(x, y) {
            if (game) {
                game.changeDirection(x, y);
            }
        }
        
        function toggleVirtualControls() {
            const controls = document.getElementById('virtualControls');
            const btn = event.target;
            
            if (controls.style.display === 'none' || !controls.style.display) {
                controls.style.display = 'grid';
                btn.textContent = 'è™šæ‹ŸæŒ‰é”®: å…³é—­';
            } else {
                controls.style.display = 'none';
                btn.textContent = 'è™šæ‹ŸæŒ‰é”®: å¼€å¯';
            }
        }
        
        function setGameSpeed(level) {
            // æ›´æ–°é€Ÿåº¦é€‰æ‹©æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å¦‚æœæ¸¸æˆå·²åˆ›å»ºï¼Œæ›´æ–°é€Ÿåº¦
            if (game) {
                game.setSpeed(level);
            } else {
                // åˆ›å»ºä¸´æ—¶æ¸¸æˆå®ä¾‹æ¥è®¾ç½®é€Ÿåº¦
                const tempGame = new SnakeGame();
                tempGame.setSpeed(level);
                game = tempGame;
            }
        }
        
        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        // é˜²æ­¢è§¦æ‘¸æ»šåŠ¨
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¾ç½®ç”»å¸ƒ
        window.addEventListener('resize', () => {
            if (game) {
                game.setupCanvas();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            // æ£€æµ‹ç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            
            if (isMobile) {
                document.getElementById('virtualControls').style.display = 'grid';
                document.querySelector('.settings-btn').textContent = 'è™šæ‹ŸæŒ‰é”®: å…³é—­';
            }
            
            // åˆ›å»ºæ¸¸æˆå®ä¾‹ä½†ä¸å¯åŠ¨
            game = new SnakeGame();
            
            // æ‰‹åŠ¨å¯åŠ¨æ¸²æŸ“å¾ªç¯ä»¥æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            game.render();
        });
    </script>
</body>
</html>